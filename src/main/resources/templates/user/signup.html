<!doctype html>
<html lang="ko" style="height:100%;" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
            integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Raleway:wght@600;800&display=swap"
          rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="/lib/lightbox/css/lightbox.min.css" rel="stylesheet">
    <link href="/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <!--    <link href="/css/bootstrap.min.css" rel="stylesheet">-->

    <!-- Template Stylesheet -->
    <link href="/css/style.css" rel="stylesheet">

    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

</head>

<body style="height:100%;">

<!-- Spinner Start -->
<div id="spinner"
     class="show w-100 vh-100 bg-white position-fixed translate-middle top-50 start-50  d-flex align-items-center justify-content-center">
    <div class="spinner-grow text-primary" role="status"></div>
</div>
<!-- Spinner End -->

<div class="position-relative" style="height:100%;">
    <div class="position-absolute top-50 start-50 translate-middle">
        <div class="card">
            <div class="card-body">
                <div class="text-center my-5 pb-2">
                    <a href="/" class="navbar-brand text-align-center"><img src="/img/GamePT.svg" style="width:250px; height:auto;" alt="logo" /></a>
                </div>

                <h4 class="card-title text-center">회원가입</h4>
                <p class="card-text text-center mt-3">모든 게이머들을 위한 GamePT에 오신것을 환영합니다.</p>

                <form class="needs-validation" th:action="@{/user/signup}" th:object="${signup}" method="post" enctype="multipart/form-data">
                    <div th:replace="~{form_errors :: formErrorsFragment}"></div>
                    <div>
                        <div class="input-group has-validation">
                            <div class="form-floating">
                                <input name="username" type="text" th:field="*{username}" class="form-control" id="username" placeholder="Login Id"  aria-describedby="inputGroupPrepend" required>
                                <label for="username">Login Id</label>
                            </div>
                            <button class="btn btn-outline-secondary isUnique" type="button" value="username">중복확인</button>
                        </div>

                        <div class="form-floating mt-3">
                            <input name="password" type="password" th:field="*{password}" class="form-control pwInput" id="password" placeholder="Password" aria-describedby="inputGroupPrepend" required>
                            <label for="password">Password</label>
                        </div>
                        <div class="form-floating mt-2">
                            <input name="passwordConfirm" type="password" th:field="*{passwordConfirm}" class="form-control pwInput" id="passwordConfirm" placeholder="Password" aria-describedby="inputGroupPrepend" required>
                            <label for="passwordConfirm">Password Confirm</label>
                        </div>

                        <div class="input-group mt-3 has-validation">
                            <div class="form-floating">
                                <input name="email" type="email" class="form-control" th:field="*{email}" id="email" placeholder="Email" aria-describedby="inputGroupPrepend" required>
                                <label for="email">Email</label>
                            </div>
                            <button class="btn btn-outline-secondary isUnique" type="button" value="email">중복확인</button>
                        </div>

                        <div class="mt-3 input-group has-validation">

                            <div class="form-floating">
                                <input name="nickname" type="text" class="form-control" th:field="*{nickname}" id="nickname" placeholder="Password" aria-describedby="inputGroupPrepend" required>
                                <label for="nickname">Nickname</label>
                            </div>

                            <button class="btn btn-outline-secondary isUnique" type="button" value="nickname">중복확인</button>
                        </div>

                        <div class="mt-3 input-group has-validation">

                            <div class="form-floating">
                                <input name="gameName" type="text" class="form-control" th:field="*{gameName}" id="gameName" placeholder="소환사명" aria-describedby="inputGroupPrepend" required>
                                <label for="nickname">소환사명</label>
                            </div>
                            <div class="form-floating">
                                <input name="tag" type="text" class="form-control" th:field="*{tag}" id="tag" placeholder="tag" aria-describedby="inputGroupPrepend" required>
                                <label for="nickname">태그 ex)KR1 </label>
                            </div>

                            <button class="btn btn-outline-secondary isUnique" type="button" value="gameName-tag">중복확인</button>
                        </div>

                        <div class="mt-3 row">
                            <div class="col-2 text-center">
                                <img style="width:50px; height:50px; object-fit:scale-down;" id="preview" class="preview" src="/img/kakako-00.jpg">
                            </div>
                            <div class="col-10">
                                <input class="form-control form-control-lg profileImg" name="profileImg" id="profileImg" type="file" accept="image/gif,image/jpeg,image/png">
                            </div>
                        </div>

                        <button class="btn btn-outline-primary mt-3 w-100" id="submit" type="submit">회원가입</button>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <a href="/user/findUserInfo">ID/PW 찾기</a>
                            <a href="/user/login">로그인</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript Libraries -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/lib/easing/easing.min.js"></script>
<script src="/lib/waypoints/waypoints.min.js"></script>
<script src="/lib/lightbox/js/lightbox.min.js"></script>
<script src="/lib/owlcarousel/owl.carousel.min.js"></script>

<!-- Template Javascript -->
<script src="/js/main.js">
</script>

<script>
    $(function() {

        $("#profileImg").on("change", function(event) {


            var file = event.target.files[0];

            var reader = new FileReader();
            reader.onload = function(e) {

                $("#preview").attr("src", e.target.result);
            }
            reader.readAsDataURL(file);
        });

        $( '.form-control' ).change( function() {
            $(this).removeClass("is-valid");
            $(this).removeClass("is-invalid");
        } );

        $( '.pwInput' ).change( function() {
            if($('#password').val().trim() != $('#passwordConfirm').val().trim()){
                $('.pwInput').removeClass("is-valid");
                $('.pwInput').addClass("is-invalid");
            }else{
                $('.pwInput').removeClass("is-invalid");
                $('.pwInput').addClass("is-valid");
            }
        } );

        $( ".isUnique" ).on( "click", function() {

            var name = $(this).val();
            var value = ""

            if(name == "gameName-tag"){
                value = $('#gameName').val().trim() + "라이엇" + $('#tag').val().trim();
            }
            else{
                value = $('#'+name).val().trim();
            }

            if(value == ""){
                alert("값을 입력해 주세요");
                return;
            }

            let regex = new RegExp('[a-z0-9]+@[a-z]+\.[a-z]{2,3}');

            if(name == "email" && !regex.test(value)){
                alert("이메일 형식이 아닙니다.");
                $('#'+name).addClass("is-invalid");

                return;
            }

            var token = $("meta[name='_csrf']").attr("content");
		    var header = $("meta[name='_csrf_header']").attr("content");

            $.ajax({
                type : 'post',              // 타입 (get, post, put 등등)
                url : '/user/isUnique',     // 요청할 서버url
                async : true,               // 비동기화 여부 (default : true)
                beforeSend : function(xhr) {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
                    xhr.setRequestHeader(header, token);
                },
                headers : {                 // Http header
                    "Content-Type" : "application/json",
                    "X-HTTP-Method-Override" : "POST"
                },
                dataType : 'text',          // 데이터 타입 (html, xml, json, text 등등)
                data : JSON.stringify({     // 보낼 데이터 (Object , String, Array)
                    "name" : name,
                    "value" : value
                }),
                success : function(result) { // 결과 성공 콜백함수
                    let data = JSON.parse(result)
                    alert(data.message);

                    if(name == "gameName-tag"){
                        if(data.isSuccess){
                            $('#gameName').addClass("is-valid");
                            $('#tag').addClass("is-valid");
                        }else{
                            $('#gameName').addClass("is-invalid");
                            $('#tag').addClass("is-invalid");
                        }
                    }else{
                        if(data.isSuccess){
                            $('#'+name).addClass("is-valid");
                        }else{
                            $('#'+name).addClass("is-invalid");
                        }
                    }


                  },
                error : function(request, status, error) { // 결과 에러 콜백함수
                        console.log(error)
                }
            })

        } );

    });
</script>

</body>

</html>